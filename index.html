<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cotação de Peças - Amigão</title>

<style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width:1100px; }
    h1 { margin: 0 0 8px 0; }
    .header-row { display:flex; gap:20px; align-items:flex-start; justify-content:space-between; }
    .company { max-width:70%; }
    .fields { margin-top: 12px; display:flex; gap:12px; }
    .fields input { padding:6px; width:100%; box-sizing:border-box; }
    label.small { font-size: 12px; display:block; margin-bottom:4px; color:#333; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#f0f0f0; }
    input[type="text"], input[type="number"], textarea { width:100%; padding:6px; box-sizing:border-box; }
    textarea { min-height:72px; resize:vertical; }
    .controls { margin-top: 12px; }
    .controls button { padding:10px 16px; margin-right:8px; border:none; background:#1a73e8; color:#fff; border-radius:6px; cursor:pointer; }
    .controls button.pdf { background:#E53935; }
    .controls button.whatsapp { background:#25D366; }
    .controls button.save { background:#4CAF50; }
    .total { margin-top:16px; font-size:18px; font-weight:bold; }
    .meta { font-size:13px; color:#333; margin-top:6px; }
    .small-note { font-size:12px; color:#666; margin-top:6px; }
</style>
</head>
<body>

<div class="header-row">
    <div class="company">
        <h1>AMIGÃO PEÇAS ELÉTRICAS LTDA</h1>
        <div class="meta">
            CNPJ: 21.543.355/0001-05  •  I.E.: 083.075.26-7<br>
            Rua Pedro Zangrande, 698 - Jardim Limoeiro - Serra/ES
            Telefone:(27)3065-9999 Zap:(27)99818-5711
        </div>
        <div class="small-note" id="cotacaoMeta"></div>
    </div>

    <!-- (A imagem do logo também será colocada no PDF; aqui é apenas visual opcional) -->
    <div id="logoPreview">
        <!-- Logo preview (optional) -->
    </div>
</div>

<!-- Cliente / Veículo / Placa -->
<div style="margin-top:12px;">
    <div style="display:flex; gap:12px;">
        <div style="flex:2">
            <label class="small">Cliente</label>
            <input type="text" id="cliente" placeholder="Nome do cliente / empresa">
        </div>
        <div style="flex:1">
            <label class="small">Veículo</label>
            <input type="text" id="veiculo" placeholder="Ex: VW Gol 2012">
        </div>
        <div style="flex:1">
            <label class="small">Placa</label>
            <input type="text" id="placa" placeholder="Ex: ABC1D23">
        </div>
    </div>
</div>

<br>

<label><b>Observação:</b></label>
<textarea id="obs" placeholder="Observações que aparecerão no PDF"></textarea>

<table id="quotationTable">
    <thead>
        <tr>
            <th>Descrição</th>
            <th>Fornecedor</th>
            <th>Qtd</th>
            <th>Custo</th>
            <th>Preço Venda</th>
            <th>% Venda</th>
            <th>% Desconto</th>
            <th>Ação</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><input type="text" class="desc"></td>
            <td><input type="text" class="forn"></td>
            <td><input type="number" class="quantity" min="0" value="1" oninput="calculateTotal()"></td>
            <td><input type="number" class="cost" min="0" value="0" oninput="updatePrice(this)"></td>
            <td><input type="number" class="price" readonly></td>
            <td><input type="number" class="percent" min="0" value="0" oninput="updatePrice(this)"></td>
            <td><input type="number" class="discount" min="0" value="0" oninput="calculateTotal()"></td>
            <td><button onclick="removeRow(this)">X</button></td>
        </tr>
    </tbody>
</table>

<div class="controls">
    <button id="addBtn" onclick="addRow()">Adicionar Linha</button>
    <button class="pdf" onclick="generatePDF()">Gerar PDF</button>
    <button class="whatsapp" onclick="sendWhatsApp()">Enviar WhatsApp</button>
    <button class="save" onclick="salvarCotacao()">Salvar Cotação</button>
</div>

<div class="total">
    Total: R$ <span id="totalValue">0,00</span>
</div>

<div class="small-note">
    <em>Observação: desconto por item é em percentual (%) e aplicado sobre (PreçoVenda × Qtde).</em>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
/* ----------------------------
   Logo embutida (Base64)
   Arquivo usado: /mnt/data/3885a012-5105-4394-b2ec-c1a84dba0693.png
   ---------------------------- */
const logoData = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAjQAAACvCAIAAABl19P9AAAQAElEQVR4Aez9Z5...l0AOiNaETRAgNHK9HBA+Pab2+qMuJ9Wbu7p7tngBmSOBQJIvurrMjIyMyIyMjM";
/* NOTA: A string acima foi truncada aqui no preview de resposta. O arquivo real contém a Base64 completa.
   Se copiar diretamente do seu navegador a partir do arquivo que você recebeu, mantenha o conteúdo inteiro. */

/* -- UTIL: gerar número automático da cotação (persistido em localStorage) -- */
function getNextCotacaoNumber() {
    const key = "amigao_cotacao_seq";
    let seq = parseInt(localStorage.getItem(key) || "0", 10);
    seq = seq + 1;
    localStorage.setItem(key, seq);
    // formato COT-0001
    return "COT-" + String(seq).padStart(4, "0");
}

/* Atualiza exibição do meta (número + data) */
function updateMetaDisplay() {
    const num = localStorage.getItem("amigao_current_cot") || getNextCotacaoNumber();
    localStorage.setItem("amigao_current_cot", num);
    const data = new Date();
    const dataStr = data.toLocaleString();
    document.getElementById("cotacaoMeta").innerText = `Nº Cotação: ${num}   •   Data: ${dataStr}`;
}

/* Chamar no carregamento */
updateMetaDisplay();

/* Preview do logo na tela (opcional) */
(function showLogoPreview(){
    const img = document.createElement("img");
    img.src = logoData;
    img.style.maxWidth = "220px";
    img.style.height = "auto";
    img.alt = "Logo Amigão";
    document.getElementById("logoPreview").appendChild(img);
})();

/* Funções de manipulação da tabela */
function addRow() {
    const tbody = document.querySelector("#quotationTable tbody");
    const row = document.createElement("tr");
    row.innerHTML = `
        <td><input type="text" class="desc"></td>
        <td><input type="text" class="forn"></td>
        <td><input type="number" class="quantity" min="0" value="1" oninput="calculateTotal()"></td>
        <td><input type="number" class="cost" min="0" value="0" oninput="updatePrice(this)"></td>
        <td><input type="number" class="price" readonly></td>
        <td><input type="number" class="percent" min="0" value="0" oninput="updatePrice(this)"></td>
        <td><input type="number" class="discount" min="0" value="0" oninput="calculateTotal()"></td>
        <td><button onclick="removeRow(this)">X</button></td>
    `;
    tbody.appendChild(row);
}

function removeRow(btn) {
    btn.parentNode.parentNode.remove();
    calculateTotal();
}

function updatePrice(element) {
    const row = element.parentNode.parentNode;
    const cost = parseFloat(row.querySelector(".cost").value) || 0;
    const percent = parseFloat(row.querySelector(".percent").value) || 0;
    const price = cost + (cost * percent / 100);
    row.querySelector(".price").value = price.toFixed(2);
    calculateTotal();
}

function calculateTotal() {
    let total = 0;
    document.querySelectorAll("#quotationTable tbody tr").forEach(row => {
        const qty = parseFloat(row.querySelector(".quantity").value) || 0;
        const price = parseFloat(row.querySelector(".price").value) || 0;
        const discountPercent = parseFloat(row.querySelector(".discount").value) || 0;
        const discountValue = (qty * price) * (discountPercent / 100);
        const subtotal = (qty * price) - discountValue;
        total += subtotal;
    });
    document.getElementById("totalValue").textContent = total.toFixed(2);
}

/* ----------------------------
   GERAR PDF (melhor layout)
   ---------------------------- */
function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt', format:'a4'}); // points unit for precise placement

    const pageWidth = doc.internal.pageSize.getWidth();

    // Cabeçalho: empresa (esquerda) e logo (direita)
    doc.setFontSize(12);
    doc.text("AMIGÃO PEÇAS ELÉTRICAS LTDA", 40, 40);
    doc.setFontSize(10);
    doc.text("CNPJ: 21.543.355/0001-05  •  I.E.: 083.075.26-7", 40, 56);
    doc.text("Rua Pedro Zangrande, 698 - Jardim Limoeiro - Serra/ES", 40, 72);

    // Número da cotação e data + cliente info
    const cotNum = localStorage.getItem("amigao_current_cot") || getNextCotacaoNumber();
    const data = new Date();
    const dataStr = data.toLocaleString();

    doc.setFontSize(10);
    doc.text(`Cotação Nº: ${cotNum}`, pageWidth - 200, 40);
    doc.text(`Data: ${dataStr}`, pageWidth - 200, 56);

    // Cliente / Veículo / Placa
    const cliente = (document.getElementById("cliente").value || "").trim();
    const veiculo = (document.getElementById("veiculo").value || "").trim();
    const placa = (document.getElementById("placa").value || "").trim();

    doc.setFontSize(11);
    doc.text(`Cliente: ${cliente}`, 40, 98);
    doc.text(`Veículo: ${veiculo}`, 40, 114);
    doc.text(`Placa: ${placa}`, 40, 130);

    // Adicionar logo à direita do cabeçalho (ajuste tamanho conforme necessário)
    try {
        // ajustar largura máxima do logo (pt), manter proporção
        const logoMaxWidth = 140;
        const imgProps = doc.getImageProperties(logoData);
        const imgRatio = imgProps.width / imgProps.height;
        const logoW = logoMaxWidth;
        const logoH = logoW / imgRatio;
        doc.addImage(logoData, 'PNG', pageWidth - logoW - 40, 28, logoW, logoH);
    } catch (e) {
        // Se falhar, simplesmente não adiciona a imagem
        console.warn("Não foi possível inserir o logo no PDF:", e);
    }

    // Montar dados da tabela para autoTable (não inclui fornecedor e desconto individual no PDF)
    const body = [];
    let descontoTotalAplicado = 0;
    document.querySelectorAll("#quotationTable tbody tr").forEach(row => {
        const desc = row.querySelector(".desc").value || "";
        const qty = parseFloat(row.querySelector(".quantity").value) || 0;
        const price = parseFloat(row.querySelector(".price").value) || 0;
        const discountPercent = parseFloat(row.querySelector(".discount").value) || 0;
        const discountValue = (qty * price) * (discountPercent / 100);
        descontoTotalAplicado += discountValue;
        const subtotal = (qty * price) - discountValue;

        body.push([desc, qty.toString(), "R$ " + price.toFixed(2), "R$ " + subtotal.toFixed(2)]);
    });

    // Desenhar tabela (autoTable)
    doc.autoTable({
        head: [['Descrição', 'Qtd', 'Preço Venda', 'Subtotal']],
        body: body,
        startY: 150,
        styles: { fontSize: 10, cellPadding: 6 },
        headStyles: { fillColor: [220,220,220], textColor: 0 },
        theme: 'grid',
        margin: { left: 40, right: 40 }
    });

    // Pós-tabela: Observação, Desconto Total (se houver), Total Geral
    let cursorY = doc.lastAutoTable.finalY + 12;

    const obs = (document.getElementById("obs").value || "").trim();
    if (obs) {
        doc.setFontSize(11);
        doc.text("Observação:", 40, cursorY);
        cursorY += 14;
        // quebrar linhas longas manualmente
        const splitObs = doc.splitTextToSize(obs, pageWidth - 80);
        doc.setFontSize(10);
        doc.text(splitObs, 40, cursorY);
        cursorY += (splitObs.length * 12) + 6;
    }

    if (descontoTotalAplicado > 0) {
        doc.setFontSize(11);
        doc.text(`Desconto Total Aplicado: R$ ${descontoTotalAplicado.toFixed(2)}`, 40, cursorY);
        cursorY += 16;
    }

    const total = parseFloat(document.getElementById("totalValue").textContent || "0").toFixed(2);
    doc.setFontSize(12);
    doc.text(`Total Geral: R$ ${total}`, 40, cursorY);

    // Rodapé (opcional)
    const footerY = doc.internal.pageSize.getHeight() - 40;
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text("Validade da cotação: 7 dias | Obrigado pela preferência.", 40, footerY);

    // Salvar PDF - o nome inclui o número da cotação
    doc.save(`${cotNum}_cotacao.pdf`);

    // Atualiza sequência para próxima cotação
    localStorage.setItem("amigao_current_cot", getNextCotacaoNumber());
    updateMetaDisplay();
}

/* ----------------------------
   Enviar mensagem via WhatsApp (inclui observação e descontos em %)
   ---------------------------- */
function sendWhatsApp() {
    let message = "*COTAÇÃO DE PEÇAS*\n\n";

    const cliente = (document.getElementById("cliente").value || "").trim();
    if (cliente) message += `Cliente: ${cliente}\n`;

    document.querySelectorAll("#quotationTable tbody tr").forEach(row => {
        const desc = row.querySelector(".desc").value || "";
        const qty = row.querySelector(".quantity").value || 0;
        const price = parseFloat(row.querySelector(".price").value || 0).toFixed(2);
        const discountPercent = parseFloat(row.querySelector(".discount").value || 0);
        const discountText = discountPercent > 0 ? ` | Desconto: ${discountPercent}%` : "";
        if (desc) {
            message += `• ${desc}\n  Qtde: ${qty} | Preço: R$ ${price}${discountText}\n\n`;
        }
    });

    const total = document.getElementById("totalValue").textContent;
    message += `*TOTAL: R$ ${total}*\n`;

    const obs = (document.getElementById("obs").value || "").trim();
    if (obs) message += `\n*Observação:* ${obs}`;

    const phone = prompt("Digite o número do cliente (ex: 5527998185711):");
    if (phone) {
        const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
        window.open(url, "_blank");
    }
}

/* ----------------------------
   SALVAR COTAÇÃO LOCAL (exemplo simples)
   - Esta função salva uma cópia no localStorage (pode ser adaptada para enviar a um PHP / API)
   ---------------------------- */
function salvarCotacao() {
    const items = [];
    document.querySelectorAll("#quotationTable tbody tr").forEach(row => {
        items.push({
            descricao: row.querySelector(".desc").value || "",
            fornecedor: row.querySelector(".forn").value || "",
            quantidade: row.querySelector(".quantity").value || 0,
            custo: row.querySelector(".cost").value || 0,
            precoVenda: row.querySelector(".price").value || 0,
            percVenda: row.querySelector(".percent").value || 0,
            percDesconto: row.querySelector(".discount").value || 0
        });
    });

    const record = {
        numero: localStorage.getItem("amigao_current_cot") || getNextCotacaoNumber(),
        data: new Date().toISOString(),
        cliente: document.getElementById("cliente").value || "",
        veiculo: document.getElementById("veiculo").value || "",
        placa: document.getElementById("placa").value || "",
        observacao: document.getElementById("obs").value || "",
        total: document.getElementById("totalValue").textContent || "0.00",
        itens: items
    };

    // Salva array de cotacoes em localStorage (exemplo simples)
    const key = "amigao_cotacoes_hist";
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    arr.unshift(record);
    localStorage.setItem(key, JSON.stringify(arr));

    alert("Cotação salva localmente no histórico do navegador.");
}

/* Inicializa uma linha de exemplo: ajusta preço inicial (se custo preenchido) */
document.addEventListener("DOMContentLoaded", () => {
    // pre-popular primeiro row preço se custo já tiver valor
    document.querySelectorAll("#quotationTable tbody tr").forEach(row => {
        updatePrice(row.querySelector(".cost"));
    });
    calculateTotal();
});
</script>

</body>
</html>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script src="firebase.js"></script>

<script>
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
  }
});
</script>

</body>
</html>
